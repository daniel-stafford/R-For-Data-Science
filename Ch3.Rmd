---
title: "Ch3"
output: html_document
date: "2024-03-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd('/Users/danielstafford/Coding/Tutorials/R-For-Data-Science')
getwd()
```

```{r}
if (!require('nycflights13')) install.packages('nycflights13')

library(nycflights13)
library(tidyverse)

#  Confclits with filter and lag. If you want to use the base version of these functions after loading dplyr, you’ll need to use their full names: stats::filter() and stats::lag().
```

```{r explore data}
?flights
flights
View(flights)
glimpse(flights) # <int> is short for integer, <dbl> is short for double (aka real numbers), <chr> for character (aka strings), and <dttm> for date-time.
```

```{r 3.1.3 dplyr basics}
flights |>
  filter(dest == "IAH") |> 
  group_by(year, month, day) |> 
  summarize(
    arr_delay = mean(arr_delay, na.rm = TRUE)
  )

# find all flights that departed more than 120 minutes (two hours) late:
flights |> 
  filter(dep_delay > 120)


# Flights that departed on January 1
flights |> 
  filter(month == 1 & day == 1)

# Flights that departed in January or February
flights |> 
  filter(month == 1 | month == 2)

# A shorter way to select flights that departed in January or February
flights |> 
  filter(month %in% c(1, 2))

flights |>
  filter(month %in% c(11,12))

feb <- flights |>
  filter(month == 2)
feb

flights |> 
  arrange(year, month, day, dep_delay, dep_time)

flights |> 
  arrange(desc(dep_delay))

# 3.2.4 distinct() 
flights |> 
  distinct() # remove any duplicate rows

# Find all unique origin and destination pairs
flights |> 
  distinct(origin, dest)

# eep other columns when filtering for unique rows, you can use the .keep_all = TRUE option.
flights |> 
  distinct(origin, dest, .keep_all = TRUE)

flights |>
  count(origin, dest, sort = TRUE)

flights |>
  count(year, month, sort = TRUE)
```


```{r 3.2.5 Exercises}
flights |>
  filter(dep_delay >= 120)
flights |>
  filter(dest %in% c("IAH", "HOU")) 
flights |>
  filter(carrier %in% c("UA", "AA", "DL")) 
flights |>
  filter(month %in% c(6,7,8)) 
flights |>
  filter(arr_delay > 120 & dep_delay == 0)

flights |>
  arrange(desc(dep_delay))

flights |>
  arrange(dep_time) |>
  view()

flights |>
  arrange(arr_time - dep_time) |>
  relocate(dep_time, arr_time)

flights |>
  distinct(month, day) |>
  arrange(month, day) |>
  count() #  OR nrow()

flights |>
  arrange(desc(distance)) |>
  relocate(distance, origin, dest) # JFK to HNL

flights |>
  arrange(distance) |>
  relocate(distance, origin, dest) # EWR to PHL

# Order does not matter
```

```{r 3.3 Columns}

# mutate
flights |> 
  mutate(
    gain = dep_delay - arr_delay,
    speed = distance / air_time * 60
  ) |>
  relocate(gain, speed) 

# add to left hand side after mutating
# mutate
flights |> 
  mutate(
    gain = dep_delay - arr_delay,
    speed = distance / air_time * 60,
    before = 1)  # equivalent to relocate gain, speed

#add after day variable, . is a sign that .before is an argument to the mutate function, not a variable name
flights |>
  mutate(
    gain = dep_delay - arr_delay,
    speed = distance / air_time * 60,
    .after = day
  )

# only keep affected variables
df_delay_gain <- flights |> 
  mutate(
    gain = dep_delay - arr_delay,
    hours = air_time / 60,
    gain_per_hour = gain / hours,
    .keep = "used"
  )

df_delay_gain

# 3.3.2 select() 

#selet columns by name
flights |> 
  select(year, month, day, carrier)

# select all columns between variables
flights |> 
  select(flight:dest)

# select all columns except variables
flights |> 
  select(!year:day) # Historically this operation was done with - instead of !, so you’re likely to see that in the wild. These two operators serve the same purpose but with subtle differences in behavior. We recommend using ! because it reads as “not” and combines well with & and |.

# select all columns with characters
flights |> 
  select(where(is.character))

# rename variables
flights |> 
  select(tail_num = tailnum) # new name on left, old on right

# further oin relocation
flights |> 
  relocate(year:dep_time, .after = time_hour)
flights |> 
  relocate(starts_with("arr"), .before = dep_time) 


```

```{r 3.3.5 Exercises}

flights |> 
  select(dep_time, sched_dep_time, dep_delay) # dep_delay diff between dep_time and sched

flights |> 
  select(dep_time:dep_delay)

flights |> 
  select(starts_with("dep") | starts_with("arr"))

flights |> 
  select(month, month, month)

variables <- c("year", "month", "day", "dep_delay", "arr_delay")

flights |> 
  select(any_of(variables))
  
flights |> 
  select(contains("TIME")) # by default, case ignored

flights |> 
  rename(air_time_min = air_time) |> 
  relocate(air_time_min, .before = 1)

flights |> 
  select(tailnum) |> 
  arrange(arr_delay) # because tailnum was selected, so arr_delay was booted
```

